// Prisma Schema for Yalavoch - Telegram OTP Service

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User: Platform users who use Yalavoch service
model User {
  id            String   @id @default(uuid())
  phoneNumber   String   @unique // E.164 format
  email         String?  @unique
  passwordHash  String
  firstName     String
  lastName      String
  projectName   String   // Application or service name
  accountType   String   @default("individual") // individual or legal_entity
  isVerified    Boolean  @default(false)
  isActive      Boolean  @default(true)
  balance       Decimal  @default(0) @db.Decimal(10, 2)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Legal entity details (optional, for business accounts)
  companyName   String?
  taxId         String?  // INN
  directorName  String?

  // Relation to API clients
  apiClients    ApiClient[]

  @@index([phoneNumber])
}

// ApiClient: Third-party apps that use your OTP service
model ApiClient {
  id          String   @id @default(uuid())
  name        String   // e.g., "Acme Corp"
  apiKey      String   @unique // Their secret API key
  webhookUrl  String?  // Optional: callback URL when OTP is verified
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  // Owner of this API client
  userId      String
  user        User     @relation(fields: [userId], references: [id])

  // Relation to OTP requests
  otpRequests OtpRequest[]

  @@index([userId])
}

// OtpRequest: Stores pending and completed verification requests
model OtpRequest {
  id          String    @id @default(uuid())
  phoneNumber String    // Phone to verify (E.164 format)
  otpCode     String?   // Null until generated by Bot
  status      String    @default("pending") // pending, code_sent, verified, expired, incorrect, timeout
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  verifiedAt  DateTime?
  serviceName String?   // Name of the service that requested OTP

  // Which client requested this verification
  clientId    String
  client      ApiClient @relation(fields: [clientId], references: [id])

  @@index([phoneNumber])
  @@index([clientId])
  @@index([createdAt])
}

// TelegramUser: Stores users who have authorized with the bot
model TelegramUser {
  id          String   @id @default(uuid())
  chatId      BigInt   @unique // Telegram chat ID for sending messages
  phoneNumber String   @unique // Verified phone number (E.164 format)
  firstName   String?
  lastName    String?
  username    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([phoneNumber])
}


// Payment: Track balance top-ups
model Payment {
  id          String   @id @default(uuid())
  userId      String
  amount      Decimal  @db.Decimal(10, 2)
  status      String   @default("pending") // pending, completed, failed
  paymentMethod String? // card, bank_transfer
  transactionId String?
  createdAt   DateTime @default(now())

  @@index([userId])
}
